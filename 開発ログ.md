# 開発ログ・ナレッジベース

## 2025-12-07: バックエンドデプロイ障害 (ディレクトリ構造不整合と解決策)

### 1. 概要
Azure App Service (Linux) へのデプロイにおいて、GitHubリポジトリの構造（`backend` フォルダ内包型）とデプロイ設定（ルート展開型）の不整合により、自動ビルド (Oryx) が機能せず、アプリケーションが起動しない問題が発生。最終的に、スタートアップコマンド内でGitクローンと環境構築を完結させる手法で解決した。

### 2. 発生した主なエラーと原因

| エラーメッセージ | 原因 |
| :--- | :--- |
| `ModuleNotFoundError: No module named 'uvicorn'` | `requirements.txt` がビルドエンジン (Oryx) に認識されず、依存関係がインストールされなかった。 |
| `Site startup probe failed` (Timeout) | 依存関係のインストールやアプリ起動に時間がかかりすぎ、Azureのヘルスチェック (230秒) に失敗した。 |
| `sh: 0: cannot open startup.sh: No such file` | GitHub Actions のアーティファクト設定ミスにより、`startup.sh` が `/home/site/wwwroot/` に配置されなかった。 |
| `git: not found` | スタートアップコマンドで `git clone` を試みたが、標準コンテナに `git` がインストールされていなかった。 |
| `FileNotFoundError: ... DigiCertGlobalRootG2.crt.pem` | GitHubリポジトリにSSL証明書が含まれておらず、クローンした環境に存在しなかった。 |

### 3. 解決策（最終設定）

**アプローチ:**
Azure標準のZipデプロイやOryxビルドに依存せず、**コンテナ起動時に毎回最新コードをGitHubから取得して環境を構築する** 方法を採用。

**Azure Portal スタートアップコマンド:**
```bash
apt-get update && apt-get install -y git && rm -rf /tmp/repo && git clone https://github.com/KandoInspireFactory/tech0-practical-backend.git /tmp/repo && cd /tmp/repo && pip install -r requirements.txt && exec gunicorn -w 4 -k uvicorn.workers.UvicornWorker app:app --bind 0.0.0.0:8000 --timeout 600
```

**アプリケーション設定 (環境変数):**
*   `WEBSITES_CONTAINER_START_TIME_LIMIT` = `1800` (起動タイムアウトを30分に延長)
*   `WEBSITES_PORT` = `8000`

### 4. 今後の改善アクション
現在の設定は「動かすための応急処置」としては強力だが、起動時間が長くかかるデメリットがある。
恒久対策として、**GitHub Actions のワークフロー修正**（`backend` ディレクトリの中身を正しくルートに展開してデプロイする設定への変更）を行い、Oryxによる自動ビルドを正常化させる必要がある。

---

## 2025-12-06: Azure App Service (Linux) + FastAPI + MySQL デプロイ対応

### 1. デプロイと起動の基本要件

#### **症状:**
*   デプロイは成功（GitHub Actions が緑）するが、サイトにアクセスすると "Application Error" または "Service Unavailable (503)" が発生する。
*   ログに "ModuleNotFoundError" や "Worker failed to boot" が記録される。

#### **原因と解決策:**

| 項目 | 原因 | 解決策 |
| :--- | :--- | :--- |
| **起動コマンド** | Azure App Service はデフォルトで Gunicorn を探すが、構成が不明確だと起動に失敗する。 | `requirements.txt` に `gunicorn` を追加。スタートアップコマンドを明示的に指定 (`gunicorn -w 4 -k uvicorn.workers.UvicornWorker app:app`)。 |
| **依存関係** | `uvicorn` だけインストールしても、Gunicorn から呼び出すための `uvicorn.workers` モジュールが含まれない場合がある。 | `requirements.txt` の記述を `uvicorn[standard]` に変更する。これにより `uvloop` や `websockets` などの必須依存関係もインストールされる。 |
| **ポート設定** | コンテナはデフォルトで 8000番などで待機するが、Azure ロードバランサは 80番への応答を期待するため、接続できない。 | Azure Portal の環境変数 `WEBSITES_PORT` に、アプリがリッスンしているポート番号（例: `8000`）を設定する。 |

---

### 2. SSL証明書とファイルパスの問題

#### **症状:**
*   デプロイ中にプロセスがハングアップする（10分以上終わらない）。
*   ログに `FileNotFoundError` や DB接続エラーが出る。

#### **原因と解決策:**

| 項目 | 原因 | 解決策 |
| :--- | :--- | :--- |
| **環境変数とパス** | ローカル（Windows）の絶対パス（例: `C:\Users\...`）を Azure（Linux）の環境変数に設定してしまうと、ファイルが見つからずアプリがクラッシュする。 | **環境変数 `SSL_CA_PATH` を削除する。** <br> 代わりに、Pythonコード内で `os.path.abspath(__file__)` を使用し、実行ファイルの場所を基準に証明書のパスを動的に生成するロジックに変更する（相対パスの絶対パス化）。 |
| **無限再起動** | 起動時のDB接続でエラーが発生すると、アプリが即座に終了し、Azure が自動で再起動を繰り返す（Crash Loop）。 | `app.py` の DB初期化処理 (`init_db`) を、`try-except` ブロックで囲み、エラーが発生してもアプリ自体は起動するようにする（ログ確認用）。 |

---

### 3. データベース接続とタイムアウト (WORKER TIMEOUT)

#### **症状:**
*   アプリは起動しようとするが、ログに `[CRITICAL] WORKER TIMEOUT` と `[ERROR] Worker ... was sent SIGKILL!` が繰り返し表示される。
*   ブラウザはずっと読み込み中のまま、最終的に 504 Gateway Timeout 等になる。

#### **原因と解決策:**

| 項目 | 原因 | 解決策 |
| :--- | :--- | :--- |
| **ネットワーク遮断** | Azure App Service から Azure Database for MySQL へのアクセスが許可されていない。 | **Azure Database for MySQL の設定 > [接続のセキュリティ] (またはネットワーク) で、「Azure 内の任意の Azure サービスからのパブリック アクセスを許可する」を「はい (ON)」にする。** |
| **起動時間** | DB接続の確立に時間がかかり、Gunicorn のデフォルトタイムアウト（30秒）を超過する。 | スタートアップコマンドに `--timeout 600` オプションを追加して、許容待機時間を延ばす。 |

---

### 4. 効率的なデバッグ手法

*   **ログストリームの活用:** Azure Portal > [監視] > [ログ ストリーム] はリアルタイム確認に必須。
*   **高度なツール (Kudu):** Azure Portal > [開発ツール] > [高度なツール] > [Debug Console] > [Bash] で、`/home/LogFiles/` 以下の `default_docker.log` を直接ダウンロードして読むのが最も詳細なエラー特定に役立つ。
*   **"Running pip install..." の確認:** デプロイ直後はビルドプロセスが走っているため、アプリが古い状態で動いていることがある。ログで `pip install` の完了を確認してから動作検証を行う。